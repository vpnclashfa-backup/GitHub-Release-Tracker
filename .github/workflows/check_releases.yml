name: Check Latest Releases

on:
  schedule:
    - cron: '0 0 * * 0' # Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± ÛŒÚ©Ø´Ù†Ø¨Ù‡ Ø³Ø§Ø¹Øª Û°Û°:Û°Û° UTC
  workflow_dispatch: # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  check-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…ÛŒØª

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create repository list file (if it doesn't exist)
        run: |
          if [ ! -f repositories.txt ]; then
            echo "https://github.com/actions/checkout" > repositories.txt
            echo "https://github.com/cli/cli" >> repositories.txt
            # Ù…Ø«Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù…Ø®Ø²Ù†ÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª ÙØ§ÛŒÙ„ urls_to_check.txt Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
            # echo "https://github.com/vpnclashfa-backup/3_c_t_o_o_l_b_o_x_p_r_o_a_n_d_r_o_i_d" >> repositories.txt
          fi
        shell: bash

      - name: Check for Latest Releases and Source URLs
        id: check_releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OUTPUT_FILE="LATEST_RELEASES.md"
          REPO_LIST_FILE="repositories.txt"
          URLS_FILENAME="urls_to_check.txt"

          echo "# ðŸš€ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ù…Ø®Ø§Ø²Ù† ðŸš€" > $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          echo "**Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ:** $(date -u '+%Y-%m-%d %H:%M:%S') UTC" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ† 'Ù…Ù†Ø¨Ø¹' Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„
          echo "| Ù…Ø®Ø²Ù† | Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ | Ù„ÛŒÙ†Ú© Ù†Ø³Ø®Ù‡ | Ù…Ù†Ø¨Ø¹ |" >> $OUTPUT_FILE
          echo "|---|---|---|---|" >> $OUTPUT_FILE

          while IFS= read -r repo_url || [[ -n "$repo_url" ]]; do
            if [ -z "$repo_url" ]; then continue; fi

            repo_path=$(echo "$repo_url" | sed -E 's|https?://github.com/||' | sed 's/\.git$//' | sed 's/\/$//')
            echo "Processing $repo_path..."
            repo_link="[$repo_path]($repo_url)"

            # --- Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ (Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„) ---
            release_data=$(gh api repos/$repo_path/releases/latest --jq '{tagName: .tag_name, url: .html_url}' 2>/dev/null)
            if [ -z "$release_data" ] || [ "$(echo "$release_data" | jq -r '.tagName')" == "null" ]; then
              tag_name="Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯"
              release_url="#"
            else
              tag_name=$(echo "$release_data" | jq -r '.tagName')
              release_url=$(echo "$release_data" | jq -r '.url')
              echo "  -> Found release: $tag_name"
            fi

            # --- Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ urls_to_check.txt (Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯) ---
            source_content="ÛŒØ§ÙØª Ù†Ø´Ø¯"
            source_url_main="https://raw.githubusercontent.com/$repo_path/main/$URLS_FILENAME"
            source_url_master="https://raw.githubusercontent.com/$repo_path/master/$URLS_FILENAME"

            # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² Ø´Ø§Ø®Ù‡ main
            echo "  -> Trying $URLS_FILENAME on main branch..."
            fetched_url=$(curl -sSfL "$source_url_main")
            exit_code=$?

            # Ø§Ú¯Ø± Ø¯Ø± main Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² Ø´Ø§Ø®Ù‡ master
            if [ $exit_code -ne 0 ]; then
              echo "  -> Trying $URLS_FILENAME on master branch..."
              fetched_url=$(curl -sSfL "$source_url_master")
              exit_code=$?
            fi

            # Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯
            if [ $exit_code -eq 0 ] && [ -n "$fetched_url" ]; then
              # Ø®ÙˆØ§Ù†Ø¯Ù† Ø®Ø· Ø§ÙˆÙ„ Ùˆ Ø­Ø°Ù ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
              first_line_url=$(echo "$fetched_url" | head -n 1 | tr -d '[:space:]')
              if [ -n "$first_line_url" ]; then
                  echo "  -> Found source URL: $first_line_url"
                  # Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ©
                  source_content="[Ù„ÛŒÙ†Ú© Ù…Ù†Ø¨Ø¹]($first_line_url)"
              else
                  echo "  -> $URLS_FILENAME found but empty for $repo_path."
              fi
            else
              echo "  -> No $URLS_FILENAME found for $repo_path."
            fi

            # --- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø·Ø± Ø¨Ù‡ ÙØ§ÛŒÙ„ Markdown (Ø¨Ø§ Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯) ---
            echo "| $repo_link | **$tag_name** | [Ù…Ø´Ø§Ù‡Ø¯Ù‡]($release_url) | $source_content |" >> $OUTPUT_FILE

          done < "$REPO_LIST_FILE"

          echo "âœ… Processing complete. File $OUTPUT_FILE generated."

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add LATEST_RELEASES.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…Ù†Ø§Ø¨Ø¹"
            git push
          fi
        shell: bash
